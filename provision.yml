---
- name: install and update packages
  hosts: all
  user: root
  tasks:
    - name: update installed packages
      apt: upgrade=dist update_cache=yes

    - name: install server base packages
      apt: name={{ item }} state=latest update_cache=yes
      with_items:
        - apt-file
        - build-essential
        - cowsay
        - curl
        - dnsutils
        - emacs24
        - gettext
        - git
        - htop
        - iotop
        - jq
        - libcurl4-openssl-dev
        - nodejs
        - pcregrep
        - pv
        - python-dev
        - python-pip
        - python3-dev
        - python3-pip
        - rsync
        - silversearcher-ag
        - speedometer
        - texinfo
        - tig
        - tmux
        - toilet
        - wget
        - zsh

- name: install rvm
  hosts: all
  user: root
  roles:
    - role: rvm_io.rvm1-ruby
      rvm1_rubies:
        - 'ruby-2.2.1'

- name: create user and configure keys
  hosts: all
  user: root
  tasks:
    - name: create user
      user: name=liam shell=/usr/bin/zsh groups=rvm append=yes

    - name: add authorized keys for liam
      authorized_key: user=liam key=https://github.com/hut8.keys

    - name: add authorized keys for root
      authorized_key: user=root key=https://github.com/hut8.keys

- name: enable passwordless sudo
  hosts: all
  user: root
  tasks:
    - copy: src=sudoers
            dest=/etc/sudoers.d/liam
            mode=440

- name: enable agent forwarding
  hosts: all
  user: root
  tasks:
    - lineinfile: dest=/etc/ssh/sshd_config
                  state=present
                  regexp='^AllowAgentForwarding'
                  line='AllowAgentForwarding yes'
      notify: restart sshd

  handlers:
    - name: restart sshd
      service: name=ssh state=restarted

- name: make swapfile
  hosts: all
  user: root
  roles:
    - { role: kamaln7.swapfile, swapfile_use_dd: True, swapfile_size: 2048 }

- name: install go
  hosts: all
  user: root
  tasks:
    - name: download go binary distribution
      get_url: >-
        dest='/tmp'
        url='https://storage.googleapis.com/golang/go1.5.2.linux-amd64.tar.gz'

    - name: extract tarball
      unarchive: >-
        src=/tmp/go1.5.2.linux-amd64.tar.gz
        dest=/usr/local/
        copy=no

- name: install go tools
  hosts: all
  user: liam
  tasks:
    - name: run installation script
      script: 'install-go-tools'
